<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic UPI Payment</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      padding: 30px;
      text-align: center;
    }
    h2 {
      color: #333;
      margin-bottom: 10px;
    }
    .upi-options {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    .upi-radio {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
      background: #fff;
      transition: 0.3s;
    }
    .upi-radio:hover {
      border-color: #2196f3;
    }
    .upi-radio input[type="radio"] {
      display: none;
    }
    .upi-radio .icon {
      width: 30px;
      height: 30px;
      background-size: cover;
      border-radius: 5px;
    }
    .icon.phonepe {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/f0/PhonePe_Logo.svg');
      background-color: #5f259f;
    }
    .icon.gpay {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/5b/Google_Pay_Logo.svg');
      background-color: #fff;
      border: 1px solid #ccc;
    }
    .icon.paytm {
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/55/Paytm_logo.png');
      background-color: #00b9f1;
    }
    .upi-radio input[type="radio"]:checked + .icon + span {
      font-weight: bold;
      color: #2196f3;
    }
    #qrContainer canvas {
      margin-top: 20px;
      border: 6px solid #eee;
      padding: 10px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    #payBtn {
      margin-top: 30px;
      padding: 12px 30px;
      font-size: 18px;
      background-color: #2196f3;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-size: 16px;
      color: #555;
    }
  </style>
</head>
<body>

  <h2>Select UPI App</h2>

  <div class="upi-options">
    <label class="upi-radio">
      <input type="radio" name="upiApp" value="phonepe">
      <span class="icon phonepe"></span>
      <span>PhonePe</span>
    </label>
    <label class="upi-radio">
      <input type="radio" name="upiApp" value="gpay">
      <span class="icon gpay"></span>
      <span>Google Pay</span>
    </label>
    <label class="upi-radio">
      <input type="radio" name="upiApp" value="paytm">
      <span class="icon paytm"></span>
      <span>Paytm</span>
    </label>
  </div>

  <div id="qrContainer"></div>

  <button id="payBtn">Pay Now</button>
  <p id="status">Waiting for action...</p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCn553qWsVz2VF1dZ4Ji5OkQDGFvMORbJE",
      authDomain: "pg-data-ed1c2.firebaseapp.com",
      databaseURL: "https://pg-data-ed1c2-default-rtdb.firebaseio.com",
      projectId: "pg-data-ed1c2",
      storageBucket: "pg-data-ed1c2.appspot.com",
      messagingSenderId: "884858492190",
      appId: "1:884858492190:web:67b7606ff790064ef3250f",
      measurementId: "G-J73RD8EH7W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    async function fetchUPI(appName) {
      const snapshot = await get(ref(db, 'upi_ids/' + appName));
      return snapshot.exists() ? snapshot.val() : null;
    }

    function saveTransaction(data) {
      set(ref(db, `transactions/${data.id}`), data);
    }

    function simulateVerify(txnId) {
      setTimeout(async () => {
        const txnRef = ref(db, `transactions/${txnId}`);
        const snapshot = await get(txnRef);
        if (snapshot.exists()) {
          const data = snapshot.val();
          data.status = "success";
          set(txnRef, data);
          showSuccessAnimation();
          playSuccessSound();
          triggerVibration();
          document.getElementById("status").innerText = "Payment Successful!";
        }
      }, 4000);
    }

    function showSuccessAnimation() {
      const msg = document.createElement("div");
      msg.innerText = "✓ Payment Successful";
      msg.style.position = "fixed";
      msg.style.top = "50%";
      msg.style.left = "50%";
      msg.style.transform = "translate(-50%, -50%)";
      msg.style.padding = "20px 40px";
      msg.style.background = "#00e676";
      msg.style.color = "#000";
      msg.style.fontSize = "24px";
      msg.style.fontWeight = "bold";
      msg.style.borderRadius = "10px";
      msg.style.boxShadow = "0 0 30px #00e676";
      msg.style.zIndex = "9999";
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 3000);
    }

    function playSuccessSound() {
      const audio = new Audio("https://www.soundjay.com/buttons/sounds/button-4.mp3");
      audio.play();
    }

    function triggerVibration() {
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }

    const qr = new QRious({
      element: document.createElement("canvas"),
      size: 220,
      value: ""
    });
    document.getElementById("qrContainer").appendChild(qr.element);

    async function updateQR(appName) {
      const upiId = await fetchUPI(appName);
      if (!upiId) return;
      const amount = 100;
      const upiUrl = `upi://pay?pa=${upiId}&pn=Receiver&am=${amount}&tn=Payment&cu=INR`;
      qr.set({ value: upiUrl });
    }

    document.querySelectorAll('input[name="upiApp"]').forEach(radio => {
      radio.addEventListener("change", (e) => {
        updateQR(e.target.value);
      });
    });

    document.getElementById("payBtn").addEventListener("click", async () => {
      const selectedApp = document.querySelector('input[name="upiApp"]:checked')?.value;
      if (!selectedApp) return alert("Select a UPI App first!");

      const upiId = await fetchUPI(selectedApp);
      if (!upiId) return alert("UPI ID not found!");

      const amount = 100;
      const txnId = "TXN" + Date.now();

      saveTransaction({
        id: txnId,
        upi: upiId,
        amount,
        status: "pending",
        createdAt: new Date().toISOString()
      });

      document.getElementById("status").innerText = "Checking payment status…";
      simulateVerify(txnId);

      const upiUrl = `upi://pay?pa=${upiId}&pn=Receiver&am=${amount}&tn=Payment&cu=INR`;
      window.location.href = upiUrl;
    });
  </script>

</body>
</html>
