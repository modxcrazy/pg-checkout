<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="admin-container">
    <h2>Admin Dashboard</h2>

    <div class="filters">
      <input type="date" id="startDate" />
      <input type="date" id="endDate" />
      <select id="statusFilter">
        <option value="all">All Status</option>
        <option value="pending">Pending</option>
        <option value="success">Success</option>
      </select>
      <button onclick="filterData()">Filter</button>
    </div>

    <canvas id="paymentChart" height="100"></canvas>

    <table class="table">
      <thead>
        <tr>
          <th>Txn ID</th>
          <th>UPI ID</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="txnTableBody"></tbody>
    </table>
  </div>

  <script type="module">
    import { db, ref, onValue } from './firebase-config.js';

    const tbody = document.getElementById("txnTableBody");
    const chartCtx = document.getElementById("paymentChart").getContext("2d");
    let fullData = [];

    const loadData = () => {
      const txnRef = ref(db, "transactions/");
      onValue(txnRef, (snapshot) => {
        tbody.innerHTML = "";
        fullData = [];
        snapshot.forEach(child => {
          const data = child.val();
          fullData.push(data);
        });
        renderTable(fullData);
        renderChart(fullData);
      });
    };

    const renderTable = (data) => {
      tbody.innerHTML = "";
      data.forEach(txn => {
        tbody.innerHTML += `
          <tr>
            <td>${txn.id}</td>
            <td>${txn.upi}</td>
            <td>â‚¹${txn.amount}</td>
            <td style="color:${txn.status === 'success' ? 'lightgreen' : 'orange'}">${txn.status}</td>
            <td>${new Date(txn.createdAt).toLocaleString()}</td>
          </tr>
        `;
      });
    };

    const renderChart = (data) => {
      const success = data.filter(d => d.status === "success").length;
      const pending = data.filter(d => d.status === "pending").length;

      new Chart(chartCtx, {
        type: "doughnut",
        data: {
          labels: ["Success", "Pending"],
          datasets: [{
            data: [success, pending],
            backgroundColor: ["#00e676", "#ff9800"]
          }]
        }
      });
    };

    window.filterData = () => {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      const status = document.getElementById("statusFilter").value;

      const filtered = fullData.filter(txn => {
        const date = new Date(txn.createdAt);
        return (!isNaN(start) ? date >= start : true) &&
               (!isNaN(end) ? date <= end : true) &&
               (status === "all" || txn.status === status);
      });

      renderTable(filtered);
    };

    loadData();
  </script>
</body>
</html>
